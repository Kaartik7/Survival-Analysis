---
title: "STA475- FCA"
author: "Tanya Thaker"
date: "2024-03-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction [100 - 200 words]
Identify the statistical method you will be exploring in your simulation study (this can be a method we studied in class, for example the K-M method, a parametric model, or Cox PH model) and a question that you want to investigate in your simulation study. 

In this simulation study, we will explore the efficacy of different treatment modalities for cannabis addiction using time-to-event data analysis methods. Specifically, we will focus on comparing the effectiveness of behavioral therapy, combination therapy (combining cognitive behavioral therapy with motivational enhancement therapy), and peer support groups. Our goal is to investigate which treatment modality yields the highest abstinence rates over a 6-month follow-up period.

We will utilize existing studies on this topic to inform our simulation parameters. These studies suggest that cognitive behavioral therapy (CBT) alone leads to a 51% abstinence rate, while combining CBT with motivational enhancement therapy (MET) achieves an 81% abstinence rate. Peer support groups, on the other hand, reach an 86% abstinence rate. We will simulate a scenario where individuals with cannabis addiction are offered either behavioral therapy or pharmacotherapy, defining the start time as the initiation of either therapy and the end time as achieving 6 months of abstinence.

Our investigation will focus on the statistical method of Cox Proportional Hazards (PH) model to analyze the time-to-event data. Specifically, we will assess how well the Cox PH model estimates the hazard ratios associated with each treatment modality, and whether it accurately captures the differences in abstinence rates observed in the simulated data. Through this simulation, we aim to evaluate and compare the performance of statistical methods for analyzing time-to-event data in the context of treatment effectiveness for cannabis addiction.


```{r}
library(dplyr)
```


## Data generation: 
Explain how you will simulate relevant data (looking at different censoring schemes, censoring rates, and/or distributions for example). This section can be mostly code, although you should still explain how you’re simulating your data, for example how you’re simulating the response times T and how you’re inducing right censoring.
```{r}
library(dplyr)
# Dataset 1
set.seed(123) # For reproducibility


simulate_data <- function(n, success_rate, treatment) {
  
  relapse <- rbinom(n, 1, success_rate / 100) #relapse = 0: they relapsed
  time <- ifelse(relapse != 0, 6, runif(n, min = 0, max = 6))
  #status <- ifelse(time < 6, 0, 1) 
  data.frame(Treatment = treatment, Time = time, Relapse = relapse)
}

n <- 100

rates <- c(CBT = 51, CBT_MET = 81, Peer_Support = 86)

cbt_data <- simulate_data(n, rates['CBT'], 'CBT')
cbt_met_data <- simulate_data(n, rates['CBT_MET'], 'CBT+MET')
peer_support_data <- simulate_data(n, rates['Peer_Support'], 'Peer Support')

data_1 <- rbind(cbt_data, cbt_met_data, peer_support_data)
data_1 <- data_1 %>% mutate(Relapse = ifelse(Relapse == 1, 0, 1))


#Dataset 2
set.seed(31) # For reproducibility


simulate_data <- function(n, success_rate, treatment) {
  
  relapse <- rbinom(n, 1, success_rate / 100) #relapse = 0: they relapsed
  time <- ifelse(relapse != 0, 6, runif(n, min = 0, max = 6))
  #status <- ifelse(time < 6, 0, 1) 
  data.frame(Treatment = treatment, Time = time, Relapse = relapse)
}

n <- 100

rates <- c(CBT = 51, CBT_MET = 81, Peer_Support = 86)

cbt_data <- simulate_data(n, rates['CBT'], 'CBT')
cbt_met_data <- simulate_data(n, rates['CBT_MET'], 'CBT+MET')
peer_support_data <- simulate_data(n, rates['Peer_Support'], 'Peer Support')

data_2 <- rbind(cbt_data, cbt_met_data, peer_support_data)
data_2 <- data_2 %>% mutate(Relapse = ifelse(Relapse == 1, 0, 1))

#Dataset 2
set.seed(234) # For reproducibility


simulate_data <- function(n, success_rate, treatment) {
  
  relapse <- rbinom(n, 1, success_rate / 100) #relapse = 0: they relapsed
  time <- ifelse(relapse != 0, 6, runif(n, min = 0, max = 6))
  #status <- ifelse(time < 6, 0, 1) 
  data.frame(Treatment = treatment, Time = time, Relapse = relapse)
}

n <- 100

rates <- c(CBT = 51, CBT_MET = 81, Peer_Support = 86)

cbt_data <- simulate_data(n, rates['CBT'], 'CBT')
cbt_met_data <- simulate_data(n, rates['CBT_MET'], 'CBT+MET')
peer_support_data <- simulate_data(n, rates['Peer_Support'], 'Peer Support')

data_3 <- rbind(cbt_data, cbt_met_data, peer_support_data)
data_3 <- data_3 %>% mutate(Relapse = ifelse(Relapse == 1, 0, 1))


```


## Simulation

Apply your chosen method to different simulated datasets and compare the estimates you obtain with the true values. You can report things like the bias, variance, coverage probability (based on 95% confidence intervals) etc. This section can be mostly code, but it should be clearly commented

```{r}
# Load necessary libraries
library(survival)
library(survminer)
library(ggplot2)
library(dplyr)

# Assuming 'data_1' is your simulated dataset

# Fit Cox proportional hazards model
cox_model <- coxph(Surv(Time, Relapse) ~ Treatment, data = data_1)

# Check proportional hazards assumption
cox.zph_test <- cox.zph(cox_model)
cox.zph_test

ggcoxzph(cox.zph_test)

summary(cox_model)

```
Due to high p-value the assumption is not violated
```{r}
# Plot Kaplan-Meier curves
ggsurvplot(
  survfit(Surv(Time, Relapse) ~ Treatment, data = data_1),
  data = data_1,
  pval = TRUE,
  risk.table = TRUE,
  conf.int = TRUE,
  legend.title = "Treatment",
  palette = "jco"
)
data_1
```



## Discussion [300 words]
Comment on the results you obtained – do they make sense, are they surprising? If they are surprising what did you do to check that you didn’t make a mistake (sometimes, when you get surprising results, for example observing that the variance increases as the sample size increases, it’s because you made a mistake!)


## References

Generative AI - ChatGPT - Paraphrase and articulate the text for introduciton
of our study on treatment of canabis addiction.
